services:
  # Stack unificada: Backend Go + Frontend Next.js em um Ãºnico container
  app:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "4120:4120"
    environment:
      PORT: "4120"
      DB_HOST: "supabase-db"
      DB_PORT: "5432"
      DB_USER: "supabase_admin"
      DB_PASSWORD: "your-super-secret-and-long-postgres-password"
      DB_NAME: "postgres"
      DB_SSLMODE: "disable"
      SUPABASE_JWT_SECRET: "your-super-secret-jwt-token-with-at-least-32-characters-long"
      # Supabase Storage Configuration
      USE_SUPABASE_STORAGE: "true"
      SUPABASE_URL: "http://supabase-kong:8000"
      SUPABASE_SERVICE_ROLE_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyAgCiAgICAicm9sZSI6ICJzZXJ2aWNlX3JvbGUiLAogICAgImlzcyI6ICJzdXBhYmFzZS1kZW1vIiwKICAgICJpYXQiOiAxNjQxNzY5MjAwLAogICAgImV4cCI6IDE3OTk1MzU2MDAKfQ.DaYlNEoUrrEn2Ig7tqibS-PHK5vgusbcbo7X36XVt4Q"
      SUPABASE_STORAGE_BUCKET: "mensager-media"
      # Frontend path
      FRONTEND_PATH: "/app/manager/dist"
      # Fallback para storage local
      MEDIA_BASE_URL: "http://localhost:4120/media"
    networks:
      - default
      - supabase_network
      - vps-net
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:4120/api/v1/health"]
      interval: 10s
      timeout: 3s
      retries: 10

networks:
  default:
    driver: bridge
  supabase_network:
    external: true
    name: supabase_default
  vps-net:
    external: true
